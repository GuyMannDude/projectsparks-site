(function(global) {
    'use strict';
    
    function ChatboxReader(options) {
        this.options = Object.assign({
            container: '#chatbox-reader',
            messages: [],
            showTimestamps: true,
            autoScroll: true
        }, options);
        
        this.container = typeof this.options.container === 'string' 
            ? document.querySelector(this.options.container)
            : this.options.container;
            
        this.messages = this.options.messages || [];
        this.init();
    }
    
    ChatboxReader.prototype.init = function() {
        if (!this.container) {
            console.error('ChatboxReader: Container not found');
            return;
        }
        
        this.createReader();
        this.render();
    };
    
    ChatboxReader.prototype.createReader = function() {
        this.container.innerHTML = `
            <div class="chatbox-reader">
                <div class="chatbox-reader-header">Messages</div>
                <div class="chatbox-reader-messages"></div>
            </div>
        `;
        
        this.messagesContainer = this.container.querySelector('.chatbox-reader-messages');
    };
    
    ChatboxReader.prototype.render = function() {
        if (this.messages.length === 0) {
            this.messagesContainer.innerHTML = '<div class="chatbox-reader-empty">No messages yet</div>';
            return;
        }
        
        const messagesHtml = this.messages.map(message => this.renderMessage(message)).join('');
        this.messagesContainer.innerHTML = messagesHtml;
        
        if (this.options.autoScroll) {
            this.scrollToBottom();
        }
    };
    
    ChatboxReader.prototype.renderMessage = function(message) {
        const time = this.options.showTimestamps ? 
            `<div class="chatbox-message-time">${this.formatTime(message.timestamp || new Date())}</div>` : '';
            
        return `
            <div class="chatbox-message ${message.type || 'user'}">
                <div class="chatbox-message-content">${this.escapeHtml(message.content)}</div>
                ${time}
            </div>
        `;
    };
    
    ChatboxReader.prototype.addMessage = function(message) {
        this.messages.push(message);
        this.render();
    };
    
    ChatboxReader.prototype.clearMessages = function() {
        this.messages = [];
        this.render();
    };
    
    ChatboxReader.prototype.setMessages = function(messages) {
        this.messages = messages;
        this.render();
    };
    
    ChatboxReader.prototype.scrollToBottom = function() {
        const reader = this.container.querySelector('.chatbox-reader');
        reader.scrollTop = reader.scrollHeight;
    };
    
    ChatboxReader.prototype.formatTime = function(date) {
        if (!(date instanceof Date)) {
            date = new Date(date);
        }
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    };
    
    ChatboxReader.prototype.escapeHtml = function(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };
    
    global.ChatboxReader = ChatboxReader;
    
})(typeof window !== 'undefined' ? window : this);
